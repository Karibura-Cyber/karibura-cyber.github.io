<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roblox FitUp Controller</title>
<style>
  body { font-family: system-ui, sans-serif; margin:0; padding:0; background:#f5f5f5; }
  header { padding:14px 18px; background:#0b5fff; color:white; display:flex; align-items:center; }
  header h1 { margin:0; font-size:1.2rem; }
  .card { background:white; border-radius:12px; padding:14px; margin:18px auto; max-width:820px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:12px; }
  .value { background:#fff; border-radius:8px; padding:12px; text-align:center; }
  .label { font-size:0.78rem; color:#555; }
  .num { font-weight:700; font-size:1.2rem; margin-top:6px; }
  button { padding:10px 12px; border-radius:10px; border:0; background:#0b5fff; color:white; font-weight:600; cursor:pointer; }
  button.secondary { background:#e6e9f8; color:#0b2b8f; }
  .log { height:160px; overflow:auto; background:#0910220f; padding:8px; border-radius:8px; margin-top:12px; font-family:monospace; font-size:0.85rem; white-space:pre-wrap; }
  small.hint { display:block; margin-top:8px; color:#555; }
  .subtopic { font-weight:700; color:#0b5fff; }

  /* Modal Styles */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; text-align:center; }
  #otpContainer input { width:40px; text-align:center; font-size:1.2rem; border-radius:6px; border:1px solid #ddd; }
  #otpContainer { display:flex; gap:6px; justify-content:center; margin-top:12px; }
</style>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<header>
  <h1>Roblox FitUp Controller</h1>
</header>

<div class="card">
  <div><strong>Status:</strong> <span id="status">idle</span></div>

  <div class="grid">
    <div class="value"><div class="label">Acceleration X (m/s²)</div><div id="ax" class="num">—</div></div>
    <div class="value"><div class="label">Acceleration Y (m/s²)</div><div id="ay" class="num">—</div></div>
    <div class="value"><div class="label">Acceleration Z (m/s²)</div><div id="az" class="num">—</div></div>
  </div>

  <div class="grid" style="grid-template-columns:1fr 1fr">
    <div class="value"><div class="label">Acceleration (incl. gravity)</div><div id="incGravity" class="num">—</div></div>
    <div class="value"><div class="label">Timestamp</div><div id="ts" class="num">—</div></div>
  </div>

  <div style="margin-top:12px; display:flex; gap:8px;">
    <button id="openModalBtn">Enter Game Code</button>
    <button id="stopBtn" class="secondary">Stop</button>
  </div>
  <div style="margin-top:8px;">
    <small>Topic: <span id="currentTopic" class="subtopic">-</span></small>
  </div>

  <div class="log" id="log">log...</div>
  <small class="hint">Notes: Use HTTPS or localhost. MQTT broker is preconfigured.</small>
</div>

<!-- Modal -->
<div class="modal" id="otpModal">
  <div class="modal-content">
    <h2>Enter Game Code</h2>
    <div id="otpContainer"></div>
    <button id="modalStartBtn" style="margin-top:12px;">Start</button>
  </div>
</div>
<script>
  const statusEl = document.getElementById('status');
  const axEl = document.getElementById('ax');
  const ayEl = document.getElementById('ay');
  const azEl = document.getElementById('az');
  const tsEl = document.getElementById('ts');
  const incGEl = document.getElementById('incGravity');
  const logEl = document.getElementById('log');
  const stopBtn = document.getElementById('stopBtn');
  const currentTopicEl = document.getElementById('currentTopic');
  const openModalBtn = document.getElementById('openModalBtn');
  const otpModal = document.getElementById('otpModal');
  const otpContainer = document.getElementById('otpContainer');
  const modalStartBtn = document.getElementById('modalStartBtn');

  let mqttClient = null, topic = null;
  let accel = null, gyro = null;
  let accelData = { x: 0, y: 0, z: 0 };
  let gyroData = { x: 0, y: 0, z: 0 };
  let usingGeneric = false, listening = false;

  // MQTT Config
  const MQTT_BROKER = "wss://3fa4dd57d3f647aea2c4f18396d8fb39.s1.eu.hivemq.cloud:8884/mqtt";
  const MQTT_USERNAME = "karibura";
  const MQTT_PASSWORD = "Meck1201##";

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    logEl.textContent = `[${time}] ${msg}\n` + logEl.textContent;
  }
  function setStatus(s) { statusEl.textContent = s; }

  // Connect to MQTT Broker
  function connectMQTT() {
    log("Connecting to MQTT...");
    mqttClient = mqtt.connect(MQTT_BROKER, {
      clientId: "web-accel-" + Math.random().toString(16).slice(2, 8),
      username: MQTT_USERNAME,
      password: MQTT_PASSWORD,
      keepalive: 30
    });

    mqttClient.on('connect', () => log("✅ Connected to MQTT broker"));
    mqttClient.on('reconnect', () => log("🔄 Reconnecting..."));
    mqttClient.on('close', () => log("⚠️ MQTT closed"));
    mqttClient.on('error', err => log("❌ MQTT error: " + err.message));
  }
  connectMQTT();

  function publishIfPossible(data) {
    if (!topic) return;
    if (mqttClient && mqttClient.connected) {
      mqttClient.publish(topic, JSON.stringify(data));
    }
  }

  // =========================
  // Combine and Send Function
  // =========================
  function sendCombinedData(apiSource) {
    const ts = Date.now();
    const combined = {
      type: "motion",
      api: apiSource,
      accel: { ...accelData },
      gyro: { ...gyroData },
      ts
    };
    publishIfPossible(combined);
  }

  // =========================
  // Generic Sensor API
  // =========================
  function startGenericSensor() {
    try {
      accel = new Accelerometer({ frequency: 60 });
      accel.addEventListener('reading', () => {
        usingGeneric = true;
        accelData = { x: accel.x ?? 0, y: accel.y ?? 0, z: accel.z ?? 0 };
        axEl.textContent = accelData.x.toFixed(3);
        ayEl.textContent = accelData.y.toFixed(3);
        azEl.textContent = accelData.z.toFixed(3);
        tsEl.textContent = Date.now();
        incGEl.textContent = "n/a";
        sendCombinedData("generic");
      });
      accel.start();
      log('Started Generic Accelerometer');
    } catch (e) {
      log('Cannot start Accelerometer: ' + e);
      return false;
    }

    try {
      gyro = new Gyroscope({ frequency: 60 });
      gyro.addEventListener('reading', () => {
        gyroData = { x: gyro.x ?? 0, y: gyro.y ?? 0, z: gyro.z ?? 0 };
        sendCombinedData("generic");
      });
      gyro.start();
      log('Started Generic Gyroscope');
    } catch (e) {
      log('Cannot start Gyroscope: ' + e);
    }

    setStatus('running (Generic Sensor)');
    listening = true;
    return true;
  }

  function stopGenericSensor() {
    if (accel) try { accel.stop(); } catch { }
    if (gyro) try { gyro.stop(); } catch { }
    accel = null; gyro = null;
    setStatus('stopped');
    listening = false;
    log('Stopped Generic Sensors');
  }

  // =========================
  // DeviceMotion API (iOS)
  // =========================
  function deviceMotionHandler(e) {
    const a = e.acceleration || { x: 0, y: 0, z: 0 };
    const ag = e.accelerationIncludingGravity || { x: 0, y: 0, z: 0 };
    const r = e.rotationRate || { alpha: 0, beta: 0, gamma: 0 };

    accelData = { x: a.x ?? ag.x ?? 0, y: a.y ?? ag.y ?? 0, z: a.z ?? ag.z ?? 0 };
    gyroData = { x: r.alpha ?? 0, y: r.beta ?? 0, z: r.gamma ?? 0 };

    axEl.textContent = accelData.x.toFixed(3);
    ayEl.textContent = accelData.y.toFixed(3);
    azEl.textContent = accelData.z.toFixed(3);
    incGEl.textContent = `(${ag.x.toFixed(2)},${ag.y.toFixed(2)},${ag.z.toFixed(2)})`;
    tsEl.textContent = Date.now();

    sendCombinedData("devicemotion");
  }

  function startDeviceMotion() {
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
      log('iOS requires permission request...');
      setStatus('waiting for iOS permission');
      DeviceMotionEvent.requestPermission().then(res => {
        if (res === 'granted') {
          window.addEventListener('devicemotion', deviceMotionHandler);
          setStatus('running (DeviceMotion)');
          log('Started DeviceMotion (iOS)');
        } else {
          log('Permission denied');
        }
      }).catch(err => log('Permission error: ' + err));
      return false;
    }

    window.addEventListener('devicemotion', deviceMotionHandler);
    listening = true;
    setStatus('running (DeviceMotion)');
    log('Started DeviceMotion');
    return true;
  }

  function stopDeviceMotion() {
    window.removeEventListener('devicemotion', deviceMotionHandler);
    listening = false;
    setStatus('stopped');
    log('Stopped DeviceMotion');
  }

  // =========================
  // OTP Modal (Game Code)
  // =========================
  const OTP_LENGTH = 6;
  const codeInput = [];
  for (let i = 0; i < OTP_LENGTH; i++) {
    const input = document.createElement('input');
    input.type = 'text';
    input.maxLength = 1;
    otpContainer.appendChild(input);
    codeInput.push(input);
    input.addEventListener('input', () => {
      if (input.value.length > 0 && i < OTP_LENGTH - 1) codeInput[i + 1].focus();
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Backspace' && input.value === '' && i > 0) codeInput[i - 1].focus();
    });
  }

  function getOTPCode() {
    return codeInput.map(inp => inp.value.trim()).join('');
  }

  openModalBtn.addEventListener('click', () => {
    otpModal.style.display = 'flex';
    codeInput[0].focus();
  });

  modalStartBtn.addEventListener('click', () => {
    const code = getOTPCode();
    if (!/^[A-Za-z0-9]+$/.test(code)) {
      log('Game code must be alphanumeric');
      return;
    }
    if (!mqttClient || !mqttClient.connected) {
      log('MQTT not connected');
      return;
    }

    topic = `sensors/game/${code}`;
    currentTopicEl.textContent = topic;
    publishIfPossible({ status: "ok" });
    log(`✅ Sent {status:"ok"} to ${topic}`);

    otpModal.style.display = 'none';

    if ("Accelerometer" in window && startGenericSensor()) return;
    if (!startDeviceMotion()) log('DeviceMotion not automatic on iOS.');
  });

  stopBtn.addEventListener('click', () => {
    usingGeneric ? stopGenericSensor() : stopDeviceMotion();
  });

  window.onclick = function (event) {
    if (event.target == otpModal) otpModal.style.display = 'none';
  };

  // Startup detection
  (function detect() {
    log("User agent: " + navigator.userAgent);
    if ("Accelerometer" in window) log("✅ Generic Accelerometer API available");
    if ("Gyroscope" in window) log("✅ Generic Gyroscope API available");
    if (typeof DeviceMotionEvent !== 'undefined') log("✅ DeviceMotionEvent available");
  })();
</script>
</body>
</html>